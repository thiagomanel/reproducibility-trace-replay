#!/bin/bash

#
# This scriptt is used to generate and compile a strace to artc.
# Note that this script will create directories inside output_dir
# with the compiled code.
#
# Usage: $0 geninit_file input_dir output_dir
# geninit_file: file you generated with artc-geninit
# input_dir: directory with strace files
# output_dir: directory to store the directories with generated and compiled code
#


if [ ! $HOME_REPLAYER ]; then
	echo "You need to export HOME_REPLAYER"
	exit 1;
fi;

source $HOME_REPLAYER/etc/scripts-lib.sh

if [ $# -ne 3 ]; then
	echo "Usage: $0 geninit_file input_dir output_dir";
	exit 1;
fi

geninit_file=$1
input_dir=$2;
output_dir=$3;

mkdir -p $output_dir

# Note that this method receives these parameters from exec_iteration
exec_compilation() {
	local workload=$1;
	local nthreads=$2;
	local delay=$3;
	local nops=$4;
	local blksize=$5;
	local sample=$6;
	local nbackground=$7;

	local input_strace_file=$(ls $input_dir/$sample.*.$workload.$nthreads.$delay.$nops.$blksize.$sample.$nbackground.load.out.strace)
	local output_code_dir=$output_dir/$(basename $input_strace_file)

	# Generated the code
	$HOME_REPLAYER/src/replayers/artc-replayer/artc --strace $input_strace_file $geninit_file $output_code_dir

	# Compile code
	make --directory=$output_code_dir --makefile=$output_code_dir/Makefile 1> $output_code_dir/log.out 2> $output_code_dir/log.err
}

log_file=/tmp/artc-gencode-compile.$(date +%s).log

echo "===> STARTING `date` <===" > $log_file

# exec_iteration is a method in scripts-lib.sh file
exec_iteration exec_compilation 2>&1 | tee $log_file;

echo "===> FINISHED `date` <===" >> $log_file
