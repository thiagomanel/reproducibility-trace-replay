#!/bin/bash

source $HOME_REPLAYER/etc/experiment-env.conf

N_SAMPLES="10"
TARGET_DIR="/"

artc_geninit() {
	echo "--> generating init files..."
	local used_dirs="$TARGET_MNT"

	if [ ! -x $ARTC_GENINIT ]; then
		echo "You need to compile artc code for geninit, of maybe you did not set HOME_REPLAYER variable"
		exit 1;
	fi

	mkdir -p $ARTC_GENINIT_OUTDIR
	$ARTC_GENINIT -a $used_dirs > $ARTC_GENINIT_FILE
	echo "<-- finished generating init files"
}

compile_artc_trace() {
	make --directory=$1 --makefile=$1/Makefile
}

exec_artc_codegen() {
	mkdir -p $ARTC_GEN_OUTDIR

	for trace_file in $CAPTURE_OUTDIR/*.*.$workload.*.*.*.*.*.*.load.out; do
		echo "  generating code for: $trace_file"
		local artc_gen_outdir=$ARTC_GEN_OUTDIR/$(basename $trace_file)
		mkdir -p $artc_gen_outdir

		$ARTC_CODEGEN --strace $trace_file $ARTC_GENINIT_FILE $artc_gen_outdir
		echo "  compiling code for: $trace_file"
		compile_artc_trace $artc_gen_outdir
	done
}

artc_codegen() {
	echo "--> compiling traces for artc..."

	if [ ! -x $ARTC_GENINIT ]; then
		echo "You need to compile artc code for geninit, of maybe you did not set HOME_REPLAYER variable"
		exit 1;
	fi

	if [ ! -f $ARTC_GENINIT_FILE ]; then
		echo "You need to generate init file first, try --artc-geninit"
		exit 1;
	fi

	exec_artc_codegen;
	echo "<-- finished compiling traces for artc"
}

artcrun_root() {
	echo "--> executing artcrun (root policy)"
	mkdir -p $ARTC_REPLAYER_OUTDIR_ROOT

	for trace_dir in $ARTC_GEN_OUTDIR/*.*.$workload.*.*.*.*.*.*.load.out; do
		for sample in `seq 1 $N_SAMPLES`; do
			local output_file_base=$ARTC_REPLAYER_OUTDIR_ROOT/$(basename $trace_dir).$sample.root
			echo "  --> executing: $ARTC_RUN --predelay-multiplier=0 $trace_dir/bench.so $TARGET_DIR 1> $output_file_base.out 2> $output_file_base.err"
			$ARTC_RUN --predelay-multiplier=0 $trace_dir/bench.so $TARGET_DIR 1> $output_file_base.out 2> $output_file_base.err
		done
	done
	echo "<-- finished execution artcrun (root policy)"
}

artcrun_temporal() {
	echo "--> executing artcrun (temporal policy)"
	mkdir -p $ARTC_REPLAYER_OUTDIR_TEMPORAL

	for trace_dir in $ARTC_GEN_OUTDIR/*.*.$workload.*.*.*.*.*.*.load.out; do
		for sample in `seq 1 $N_SAMPLES`; do
			local output_file_base=$ARTC_REPLAYER_OUTDIR_TEMPORAL/$(basename $trace_dir).$sample.root
			echo "  --> executing: $ARTC_RUN --predelay-multiplier=0 --disable-constraints=all --enable-constraints=temporal $trace_dir/bench.so $TARGET_DIR 1> $output_file_base.out 2> $output_file_base.err"
			$ARTC_RUN --predelay-multiplier=0 --disable-constraints=all --enable-constraints=temporal $trace_dir/bench.so $TARGET_DIR 1> $output_file_base.out 2> $output_file_base.err
		done
	done
	echo "<-- finished execution artcrun (root policy)"
}

show_help() {
	echo "Usage: $0 [--run-beefs | --artc-geninit | --artc-codegen | --artcrun | --help]"
	echo
	echo "--run-beefs: runs beefs_repl"
	echo "--artc-geninit: generate init file for artc compiler (step 1)"
	echo "--artc-codegen: generates code from converted traces + init files (step 2)"
	echo "--artcrun: executes artc with the compiled traces (step 3)"
}

define_parameters() {
	while [ ! -z $1 ]; do
		case $1 in
			--run-beefs)
				echo "run-beefs (not implemented)"
				exit 0;
				;;
			--artc-geninit)
				artc_geninit;
				exit 0;
				;;
			--artc-codegen)
				artc_codegen;
				exit 0;
				;;
			--artcrun-root)
				artcrun_root;
				exit 0;
				;;
			--artcrun-temporal)
				artcrun_temporal;
				;;
			-h | --help | *)
				show_help;
				exit 1;
				;;
		esac
		shift
	done
}

main() {
	define_parameters $@;
}

main $@;
