#!/bin/bash -e

if [ ! $HOME_REPLAYER ]; then
	echo "You must to export HOME_REPLAYER first. To know more, plase take a look at the README file.";
	exit 1;
fi

# We are keeping this variable just to preserv the file names
nbackground=0;

execute() {
	local workload=$1
	local nthreads=$2
	local delay=$3
	local nops=$4
	local loader_input=$5
	local blksize=$6
	local trace_tool=$7
	local output_trace=$8

	outpath=$output_trace".out"

	foreground_bin=$HOME_REPLAYER/src/capture/workload/$workload
	foreground_cmd="$foreground_bin $nthreads $delay $nops $loader_input $blksize debug"

	case "$trace_tool" in
		baseline)
			$foreground_cmd > $outpath;
			;;
		stap)
			stap_out=$base_out".stap"
			stap -g -DSTP_NO_OVERLOAD -DMAXMAPENTRIES=10000 $HOME_REPLAYER/lib/trace.stp -c "$foreground_cmd > $outpath" > $stap_out
			;;
		strace)
			strace_out=$base_out".strace"
			strace -e trace=open,read,write,pread64,pwrite64,close -T -s -q -ttt -o $strace_out -f $foreground_cmd > $outpath
			;;
		*)
			echo $"Unknown command: $trace_tool {baseline|stap|strace}"
			exit 1
			;;
	esac
}

execute $@;
